# ============================================================================
# CI/CD Pipeline for SULLIVAN - Media Server
# ============================================================================
# Home media server running Emby, Jellyfin, Plex, Sonarr, Radarr, etc.
# Repository: nuniesmith/sullivan
#
# Services: emby, jellyfin, plex, sonarr, radarr, lidarr, jackett, qbittorrent, calibre
#
# Features:
#   - Deployment via Tailscale + SSH
#   - Docker container management
#   - Health checks
#   - Discord notifications
#
# Note: DNS records and SSL certificates are managed by Freddy's CI/CD pipeline.
#       Freddy's nginx reverse proxies Sullivan services over Tailscale.
# ============================================================================

name: üé¨ Sullivan Deploy

on:
    push:
        branches:
            - main
        paths-ignore:
            - "**.md"
            - "docs/**"
            - ".gitignore"
    pull_request:
        branches: [main]
    workflow_dispatch:
        inputs:
            skip_deploy:
                description: "Skip deployment (test workflow only)"
                required: false
                type: boolean
                default: false
            notify_discord:
                description: "Send Discord notification"
                required: false
                type: boolean
                default: true

permissions:
    contents: read

env:
    SERVER_NAME: sullivan
    PROJECT_PATH: ~/sullivan
    DOMAIN: sullivan.7gram.xyz
    # Note: Sullivan services are accessed via Freddy's nginx reverse proxy
    # DNS records point to Freddy's Tailscale IP, which proxies to Sullivan over Tailscale

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}
    cancel-in-progress: true

defaults:
    run:
        shell: bash

jobs:
    # ==========================================================================
    # DEPLOY
    # ==========================================================================
    deploy:
        name: üöÄ Deploy to Sullivan
        runs-on: ubuntu-latest
        timeout-minutes: 15
        if: |
            github.event_name == 'push' ||
            (github.event_name == 'workflow_dispatch' && !inputs.skip_deploy)

        steps:
            - name: üì• Checkout code
              uses: actions/checkout@v4

            # ======================================================================
            # TAILSCALE CONNECTION
            # ======================================================================
            - name: üîå Connect to Tailscale
              id: tailscale
              uses: nuniesmith/actions/.github/actions/tailscale-connect@main
              with:
                  oauth-client-id: ${{ secrets.TAILSCALE_OAUTH_CLIENT_ID }}
                  oauth-secret: ${{ secrets.TAILSCALE_OAUTH_SECRET }}
                  target-ip: ${{ secrets.SULLIVAN_TAILSCALE_IP }}
                  target-ssh-port: ${{ secrets.SSH_PORT || '22' }}

            # ======================================================================
            # DEPLOY VIA SSH
            # ======================================================================
            - name: üöÄ Deploy via SSH
              id: deploy
              if: steps.tailscale.outputs.connected == 'true'
              uses: nuniesmith/actions/.github/actions/ssh-deploy@main
              with:
                  host: ${{ secrets.SULLIVAN_TAILSCALE_IP }}
                  port: ${{ secrets.SSH_PORT || '22' }}
                  username: ${{ secrets.SSH_USER || 'actions' }}
                  ssh-key: ${{ secrets.SULLIVAN_SSH_KEY }}
                  project-path: ${{ env.PROJECT_PATH }}
                  git-pull: false
                  git-branch: ${{ github.ref_name }}
                  docker-pull: false
                  docker-prune: false
                  pre-deploy-command: |
                      echo "üé¨ Deploying to Sullivan server..."

                      # Expand tilde to actual home directory
                      PROJECT_DIR="${HOME}/sullivan"
                      echo "üìÅ Project directory: $PROJECT_DIR"

                      # Handle git repository setup
                      if [ ! -d "$PROJECT_DIR/.git" ]; then
                        if [ -d "$PROJECT_DIR" ] && [ "$(ls -A $PROJECT_DIR 2>/dev/null)" ]; then
                          echo "üìÅ Directory exists but is not a git repo - converting..."
                          cd "$PROJECT_DIR"

                          # Preserve local files that shouldn't be overwritten
                          BACKUP_DIR=$(mktemp -d)
                          echo "üì¶ Backing up local files to $BACKUP_DIR..."
                          [ -f .env ] && cp .env "$BACKUP_DIR/.env"
                          [ -d services ] && cp -r services "$BACKUP_DIR/services"

                          # Initialize git and fetch from remote
                          git init
                          git remote add origin https://github.com/${{ github.repository }}.git
                          git fetch origin

                          # Reset to match remote (overwrites tracked files only)
                          git reset --hard origin/${{ github.ref_name }}
                          git branch -M ${{ github.ref_name }}
                          git branch --set-upstream-to=origin/${{ github.ref_name }} ${{ github.ref_name }}

                          # Restore preserved local files
                          echo "üì¶ Restoring local files..."
                          [ -f "$BACKUP_DIR/.env" ] && cp "$BACKUP_DIR/.env" .env && echo "  ‚úì Restored .env"
                          if [ -d "$BACKUP_DIR/services" ]; then
                            # Merge services directory (preserve local configs)
                            cp -rn "$BACKUP_DIR/services"/* services/ 2>/dev/null || true
                            echo "  ‚úì Merged services configs"
                          fi
                          rm -rf "$BACKUP_DIR"

                          echo "‚úì Git repository initialized from existing directory"
                        else
                          echo "üì• First deployment - cloning repository..."
                          # Remove empty directory if it exists
                          [ -d "$PROJECT_DIR" ] && rmdir "$PROJECT_DIR" 2>/dev/null || true
                          mkdir -p "$(dirname $PROJECT_DIR)"
                          git clone https://github.com/${{ github.repository }}.git "$PROJECT_DIR"
                          cd "$PROJECT_DIR"
                          git checkout ${{ github.ref_name }}
                        fi
                      else
                        cd "$PROJECT_DIR"
                        echo "üì• Pulling latest changes..."
                        git fetch origin
                        git checkout ${{ github.ref_name }}
                        git pull origin ${{ github.ref_name }}
                      fi

                      # Ensure run.sh is executable
                      chmod +x ./run.sh 2>/dev/null || true

                      # Configure firewall for Tailscale access from Freddy
                      echo "üî• Configuring firewall for Tailscale..."
                      FREDDY_IP="${{ secrets.FREDDY_TAILSCALE_IP }}"

                      # Service ports for nginx proxy from Freddy
                      SERVICE_PORTS=(
                        22      # SSH
                        8096    # Emby
                        8920    # Emby HTTPS
                        8097    # Jellyfin
                        32400   # Plex
                        8080    # qBittorrent
                        9117    # Jackett
                        8191    # Flaresolverr
                        8989    # Sonarr
                        7878    # Radarr
                        8686    # Lidarr
                        8082    # Calibre
                        8083    # Calibre Desktop
                        8084    # Calibre-Web
                        5452    # Filebot
                        8998    # YouTube-DL
                        8200    # Duplicati
                        9925    # Mealie
                        9283    # Grocy
                        8090    # Wiki.js
                      )

                      # Enable UFW if not already enabled
                      if command -v ufw &> /dev/null; then
                        sudo ufw --force enable 2>/dev/null || true

                        # Allow SSH from anywhere (fallback)
                        sudo ufw allow 22/tcp comment 'SSH' 2>/dev/null || true

                        # Allow Tailscale interface
                        sudo ufw allow in on tailscale0 comment 'Tailscale' 2>/dev/null || true

                        # Allow all service ports from Freddy's Tailscale IP
                        if [ -n "$FREDDY_IP" ]; then
                          for port in "${SERVICE_PORTS[@]}"; do
                            sudo ufw allow from "$FREDDY_IP" to any port "$port" proto tcp comment "Sullivan service from Freddy" 2>/dev/null || true
                          done
                          echo "  ‚úì Firewall rules added for Freddy ($FREDDY_IP)"
                        else
                          echo "  ‚ö†Ô∏è FREDDY_TAILSCALE_IP not set, allowing Tailscale interface only"
                        fi

                        # Allow Plex additional ports
                        sudo ufw allow 32410:32414/tcp comment 'Plex' 2>/dev/null || true
                        sudo ufw allow 32410:32414/udp comment 'Plex' 2>/dev/null || true
                        sudo ufw allow 1900/udp comment 'Plex DLNA' 2>/dev/null || true

                        # Allow qBittorrent torrent port
                        sudo ufw allow 60000/tcp comment 'qBittorrent' 2>/dev/null || true
                        sudo ufw allow 60000/udp comment 'qBittorrent' 2>/dev/null || true

                        sudo ufw reload 2>/dev/null || true
                        echo "  ‚úì Firewall configured"
                      else
                        echo "  ‚ö†Ô∏è UFW not installed, skipping firewall configuration"
                      fi

                      # Use run.sh to generate .env file with secrets if missing
                      if [ ! -f .env ]; then
                        echo "üìù Generating .env file using run.sh..."
                        ./run.sh secrets 2>/dev/null || true
                      fi

                      # Load environment variables
                      if [ -f .env ]; then
                        set -a && source .env && set +a
                        echo "‚úì Environment loaded"
                      fi

                      # Inject API keys from GitHub secrets
                      echo "üîë Configuring API keys from GitHub secrets..."
                      SONARR_KEY="${{ secrets.SONARR_API_KEY }}"
                      RADARR_KEY="${{ secrets.RADARR_API_KEY }}"
                      LIDARR_KEY="${{ secrets.LIDARR_API_KEY }}"
                      DISCORD_KEY="${{ secrets.DOPLARR_TOKEN }}"

                      if [ -n "$SONARR_KEY" ] && [ "$SONARR_KEY" != "" ]; then
                        sed -i "s|^SONARR_API_KEY=.*|SONARR_API_KEY=${SONARR_KEY}|" .env
                        echo "  ‚úì Sonarr API key configured"
                      fi
                      if [ -n "$RADARR_KEY" ] && [ "$RADARR_KEY" != "" ]; then
                        sed -i "s|^RADARR_API_KEY=.*|RADARR_API_KEY=${RADARR_KEY}|" .env
                        echo "  ‚úì Radarr API key configured"
                      fi
                      if [ -n "$LIDARR_KEY" ] && [ "$LIDARR_KEY" != "" ]; then
                        sed -i "s|^LIDARR_API_KEY=.*|LIDARR_API_KEY=${LIDARR_KEY}|" .env
                        echo "  ‚úì Lidarr API key configured"
                      fi
                      if [ -n "$DISCORD_KEY" ] && [ "$DISCORD_KEY" != "" ]; then
                        sed -i "s|^DOPLARR_TOKEN=.*|DOPLARR_TOKEN=${DISCORD_KEY}|" .env
                        echo "  ‚úì Doplarr token configured"
                      fi

                  deploy-command: |
                      PROJECT_DIR="${HOME}/sullivan"
                      cd "$PROJECT_DIR"

                      echo "üìÇ Current directory: $(pwd)"
                      echo "üåø Git branch: $(git branch --show-current)"
                      echo "üìù Latest commit: $(git log -1 --oneline)"

                      # Deploy using run.sh
                      if [ -x "./run.sh" ]; then
                        echo "üê≥ Pulling latest images..."
                        docker compose pull --ignore-pull-failures 2>&1 || true
                        echo "üê≥ Stopping existing services..."
                        ./run.sh stop 2>/dev/null || true
                        echo "üê≥ Starting all services..."
                        ./run.sh start 2>&1
                      else
                        echo "‚ö†Ô∏è run.sh not found, using docker compose directly"
                        docker compose pull --ignore-pull-failures
                        docker compose up -d --remove-orphans
                      fi

                  post-deploy-command: |
                      PROJECT_DIR="${HOME}/sullivan"
                      cd "$PROJECT_DIR"

                      echo ""
                      echo "üìä Service Status:"
                      docker compose ps --format "table {{.Name}}\t{{.Status}}\t{{.Ports}}" 2>/dev/null || docker ps --format "table {{.Names}}\t{{.Status}}"

                      echo ""
                      echo "üíæ Disk Usage:"
                      df -h / | tail -1

                      echo ""
                      echo "üß† Memory Usage:"
                      free -h | head -2

                      echo ""
                      echo "üåê Network Note:"
                      echo "   Sullivan services are accessed via Freddy's nginx reverse proxy"
                      echo "   DNS records point to Freddy's Tailscale IP"

                      echo ""
                      echo "‚úÖ Deployment complete!"

            # ======================================================================
            # HEALTH CHECKS
            # ======================================================================
            - name: üè• Run Health Checks
              id: health-checks
              if: always() && steps.deploy.outcome == 'success'
              uses: nuniesmith/actions/.github/actions/health-check@main
              with:
                  containers: emby,jellyfin,plex,sonarr,radarr,lidarr,qbittorrent,jackett
                  ssh-host: ${{ secrets.SULLIVAN_TAILSCALE_IP }}
                  ssh-port: ${{ secrets.SSH_PORT || '22' }}
                  ssh-user: ${{ secrets.SSH_USER || 'actions' }}
                  ssh-key: ${{ secrets.SULLIVAN_SSH_KEY }}
                  initial-delay: 30
                  retry-count: 3
                  retry-delay: 10
                  fail-on-unhealthy: false

            # ======================================================================
            # DISCORD NOTIFICATION
            # ======================================================================
            - name: üì£ Notify deployment
              if: always() && (inputs.notify_discord != false)
              uses: nuniesmith/actions/.github/actions/discord-notify@main
              continue-on-error: true
              with:
                  webhook-url: ${{ secrets.DISCORD_WEBHOOK_ACTIONS }}
                  title: "üé¨ Sullivan Deployment"
                  description: "Media server deployment"
                  status: ${{ steps.deploy.outcome == 'success' && 'success' || 'failure' }}
                  include-repo-info: true
                  fields: |
                      [
                        {"name": "Server", "value": "Sullivan", "inline": true},
                        {"name": "Branch", "value": "${{ github.ref_name }}", "inline": true},
                        {"name": "Health", "value": "${{ steps.health-checks.outputs.healthy == 'true' && '‚úÖ Healthy' || '‚ö†Ô∏è Check Required' }}", "inline": true}
                      ]

    # ==========================================================================
    # PIPELINE SUMMARY
    # ==========================================================================
    summary:
        name: üìä Summary
        runs-on: ubuntu-latest
        timeout-minutes: 5
        needs: [deploy]
        if: always()

        steps:
            - name: üìä Generate summary
              run: |
                  echo "## üé¨ Sullivan Deployment Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
                  echo "|------|--------|" >> $GITHUB_STEP_SUMMARY

                  # Deploy status
                  if [ "${{ needs.deploy.result }}" = "success" ]; then
                    echo "| üöÄ Deploy | ‚úÖ Success |" >> $GITHUB_STEP_SUMMARY
                  elif [ "${{ needs.deploy.result }}" = "skipped" ]; then
                    echo "| üöÄ Deploy | ‚è≠Ô∏è Skipped |" >> $GITHUB_STEP_SUMMARY
                  else
                    echo "| üöÄ Deploy | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### üìã Details" >> $GITHUB_STEP_SUMMARY
                  echo "- **Server:** Sullivan (Media Server)" >> $GITHUB_STEP_SUMMARY
                  echo "- **Domain:** ${{ env.DOMAIN }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
                  echo "- **Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### üîß Architecture" >> $GITHUB_STEP_SUMMARY
                  echo "- Sullivan services are accessed via Freddy's nginx reverse proxy" >> $GITHUB_STEP_SUMMARY
                  echo "- DNS records and SSL certificates are managed by Freddy's CI/CD pipeline" >> $GITHUB_STEP_SUMMARY
                  echo "- Freddy proxies requests to Sullivan over Tailscale network" >> $GITHUB_STEP_SUMMARY

            - name: ‚ùå Fail on deployment error
              if: needs.deploy.result == 'failure'
              run: |
                  echo "::error::Deployment to Sullivan failed"
                  exit 1
