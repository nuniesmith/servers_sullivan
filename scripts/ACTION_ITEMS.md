# Sullivan - GitHub Actions Setup Guide

This guide walks you through setting up automated deployments for Sullivan via GitHub Actions with Tailscale.

## Prerequisites

- A server running Ubuntu/Debian with Docker installed
- A Tailscale account
- A GitHub account with access to this repository

## Quick Start

1. **Run the setup script on your server:**
   ```bash
   cd /path/to/sullivan/scripts
   chmod +x setup-production-server.sh generate-secrets.sh
   sudo ./setup-production-server.sh
   ```

2. **Copy the generated secrets to GitHub** (see below)

3. **Push to main branch to trigger deployment**

---

## Required GitHub Secrets

Go to: **Settings → Secrets and variables → Actions → New repository secret**

| Secret Name | Description | How to Get |
|-------------|-------------|------------|
| `SSH_PRIVATE_KEY` | SSH private key for actions user | Generated by `generate-secrets.sh` |
| `TAILSCALE_IP` | Tailscale IP of your server | Run `tailscale ip -4` on server |
| `TS_OAUTH_CLIENT_ID` | Tailscale OAuth Client ID | [Tailscale Admin Console](https://login.tailscale.com/admin/settings/oauth) |
| `TS_OAUTH_SECRET` | Tailscale OAuth Client Secret | [Tailscale Admin Console](https://login.tailscale.com/admin/settings/oauth) |

### Optional Secrets

| Secret Name | Description |
|-------------|-------------|
| `DISCORD_WEBHOOK` | Discord webhook for deployment notifications |
| `SULLIVAN_DIR` | Custom path to sullivan repo (default: `/home/actions/sullivan`) |

---

## Step-by-Step Setup

### 1. Server Setup

Run the setup script on your Sullivan server:

```bash
# Download/clone the repo first
git clone https://github.com/YOUR_USERNAME/sullivan.git ~/sullivan

# Run setup
cd ~/sullivan/scripts
sudo ./setup-production-server.sh
```

The script will:
- Install Docker and dependencies
- Install Tailscale
- Create the `actions` user for CI/CD
- Set up SSH directory structure
- Create `.env` template
- Optionally generate secrets

### 2. Connect Tailscale

If not already connected:

```bash
sudo tailscale up
```

Note your Tailscale IP:
```bash
tailscale ip -4
# Example output: 100.x.x.x
```

### 3. Generate Secrets

If you didn't run this during setup:

```bash
sudo ./generate-secrets.sh
```

This creates:
- SSH key pair for the `actions` user
- A credentials file with all values needed for GitHub

### 4. Create Tailscale OAuth Credentials

1. Go to [Tailscale Admin Console - OAuth](https://login.tailscale.com/admin/settings/oauth)
2. Click **"Generate OAuth Client"**
3. Set:
   - **Description:** `Sullivan CI/CD`
   - **Tags:** `tag:ci`
4. Copy the **Client ID** and **Client Secret**

**Important:** You must also add the ACL rules for the `tag:ci` tag:

Go to [Tailscale ACLs](https://login.tailscale.com/admin/acls) and add:

```json
{
    "tagOwners": {
        "tag:ci": ["autogroup:admin"]
    },
    "acls": [
        {
            "action": "accept",
            "src": ["tag:ci"],
            "dst": ["*:22"]
        }
    ]
}
```

### 5. Add Secrets to GitHub

1. Go to your repository: `https://github.com/YOUR_USERNAME/sullivan`
2. Click **Settings** → **Secrets and variables** → **Actions**
3. Click **New repository secret** for each:

#### SSH_PRIVATE_KEY
```
-----BEGIN OPENSSH PRIVATE KEY-----
(paste entire key from credentials file)
-----END OPENSSH PRIVATE KEY-----
```

#### TAILSCALE_IP
```
100.x.x.x
```
(Your server's Tailscale IP)

#### TS_OAUTH_CLIENT_ID
```
kxxxxxxxxxxxxxxx
```
(From Tailscale OAuth setup)

#### TS_OAUTH_SECRET
```
tskey-client-xxxxxxx
```
(From Tailscale OAuth setup)

#### DISCORD_WEBHOOK (Optional)
```
https://discord.com/api/webhooks/...
```

### 6. Clone Repository on Server

If not done during setup:

```bash
sudo -u actions git clone https://github.com/YOUR_USERNAME/sullivan.git /home/actions/sullivan
```

### 7. Test the Deployment

Either:
- Push a commit to the `main` branch
- Or go to **Actions** → **Deploy Sullivan** → **Run workflow**

---

## Workflow Features

### Automatic Deployment
- Triggers on push to `main` or `master`
- Pulls latest code
- Updates Docker images
- Cleans up unused images

### Manual Deployment
Go to **Actions** → **Deploy Sullivan** → **Run workflow**

Options:
- **services:** Comma-separated service names, or `all`
- **action:** `deploy`, `restart`, `stop`, or `logs`

### Discord Notifications
If configured, you'll receive notifications for:
- Deployment started
- Deployment success
- Deployment failure

---

## Troubleshooting

### SSH Connection Failed
1. Verify Tailscale is connected on both ends:
   ```bash
   tailscale status
   ```
2. Test SSH manually:
   ```bash
   ssh -i ~/.ssh/sullivan_deploy actions@<tailscale-ip>
   ```
3. Check `authorized_keys` contains the public key:
   ```bash
   cat /home/actions/.ssh/authorized_keys
   ```

### Tailscale Not Connecting in CI
1. Verify OAuth credentials are correct
2. Check the `tag:ci` is defined in ACLs
3. Look at the workflow logs for Tailscale status output

### Permission Denied
1. Ensure `actions` user is in docker group:
   ```bash
   groups actions
   ```
2. Verify file permissions:
   ```bash
   ls -la /home/actions/.ssh/
   ```

### Docker Commands Failing
Log into the server and test:
```bash
sudo -u actions docker ps
sudo -u actions docker compose --version
```

---

## Security Notes

- **Delete credentials file** after copying to GitHub:
  ```bash
  sudo rm /tmp/sullivan_credentials_*.txt
  ```
- **Never commit** SSH private keys to the repository
- **Rotate keys** periodically by running `generate-secrets.sh` again
- **Use Tailscale** - it provides encrypted WireGuard tunnels

---

## File Locations

| Item | Location |
|------|----------|
| Sullivan repo | `/home/actions/sullivan` |
| Docker compose | `/home/actions/sullivan/docker-compose.yml` |
| Environment vars | `/home/actions/sullivan/.env` |
| SSH keys | `/home/actions/.ssh/sullivan_deploy*` |
| Logs | `/home/actions/logs/` |
| Backups | `/home/actions/backups/` |

---

## Useful Commands

```bash
# Check service status
sudo -u actions docker compose -f /home/actions/sullivan/docker-compose.yml ps

# View logs
sudo -u actions docker compose -f /home/actions/sullivan/docker-compose.yml logs -f

# Restart all services
sudo -u actions docker compose -f /home/actions/sullivan/docker-compose.yml restart

# Pull latest images
sudo -u actions docker compose -f /home/actions/sullivan/docker-compose.yml pull

# Clean up Docker
docker system prune -af
```
